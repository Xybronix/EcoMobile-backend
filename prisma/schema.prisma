// Prisma Schema - Support MySQL, PostgreSQL, SQLite
// Change datasource provider based on your database

datasource db {
  provider = "mysql" // Change to "mysql" or "postgresql" or "sqlite" as needed
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  address       String?
  avatar        String?
  role          UserRole @default(USER)
  status        String   @default("active")
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  language      String   @default("fr")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  wallet        Wallet?
  rides         Ride[]
  notifications Notification[]
  chatMessages  ChatMessage[]
  incidents     Incident[]
  sessions      Session[]
  activityLogs  ActivityLog[]
  reviews       Review[]     // Relation avec les avis
  roleId        String?
  roleRelation  Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  resource    String   
  action      String   
  createdAt   DateTime @default(now())

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String @db.VarChar(36)
  permissionId String @db.VarChar(36)

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String   
  resource   String   
  resourceId String?  
  details    String?  
  metadata   Json?    
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  type            TransactionType
  amount          Float
  fees            Float             @default(0)
  totalAmount     Float
  status          TransactionStatus @default(PENDING)
  paymentMethod   String?
  paymentProvider String?
  externalId      String?
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Bike {
  id                String     @id @default(uuid())
  code              String     @unique
  model             String
  status            BikeStatus @default(AVAILABLE)
  batteryLevel      Int        @default(100)
  latitude          Float?
  longitude         Float?
  locationName      String?    
  equipment         Json?
  lastMaintenanceAt DateTime?
  qrCode            String     @unique
  gpsDeviceId       String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  rides            Ride[]
  maintenanceLogs  MaintenanceLog[]
  incidents        Incident[]

  @@map("bikes")
}

model Ride {
  id             String     @id @default(uuid())
  userId         String
  bikeId         String
  startTime      DateTime   @default(now())
  endTime        DateTime?
  startLatitude  Float
  startLongitude Float
  endLatitude    Float?
  endLongitude   Float?
  distance       Float?
  duration       Int?       // Dur√©e en heures
  cost           Float?
  status         RideStatus @default(IN_PROGRESS)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  bike Bike @relation(fields: [bikeId], references: [id], onDelete: Cascade)

  @@map("rides")
}

model MaintenanceLog {
  id          String   @id @default(uuid())
  bikeId      String
  type        String
  description String
  cost        Float?
  performedBy String?
  createdAt   DateTime @default(now())

  // Relations
  bike Bike @relation(fields: [bikeId], references: [id], onDelete: Cascade)

  @@map("maintenance_logs")
}

model Incident {
  id           String         @id @default(uuid())
  userId       String
  bikeId       String?
  type         String
  description  String
  status       IncidentStatus @default(OPEN)
  priority     String         @default("MEDIUM")
  resolvedAt   DateTime?
  refundAmount Float?
  adminNote    String?
  resolvedBy   String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  bike Bike? @relation(fields: [bikeId], references: [id], onDelete: SetNull)

  @@map("incidents")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String
  message   String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  device    String?
  location  String?
  ipAddress String?
  userAgent String?  @db.Text
  isActive  Boolean  @default(true)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model Settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model PricingConfig {
  id             String   @id @default(uuid())
  unlockFee      Float    @default(100)  
  baseHourlyRate Float   @default(200)  
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  plans         PricingPlan[]
  rules         PricingRule[]
  promotions    Promotion[]

  @@map("pricing_configs")
}

model PricingPlan {
  id              String        @id @default(uuid())
  pricingConfigId String
  name            String
  hourlyRate      Float         
  dailyRate       Float         
  weeklyRate      Float         
  monthlyRate     Float         
  minimumHours    Int           @default(1) 
  discount        Float         @default(0)
  isActive        Boolean       @default(true)
  conditions      Json?         
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  pricingConfig   PricingConfig @relation(fields: [pricingConfigId], references: [id], onDelete: Cascade)
  promotions      PromotionPlan[]

  @@map("pricing_plans")
}

model PricingRule {
  id              String        @id @default(uuid())
  pricingConfigId String
  name            String
  dayOfWeek       Int?          
  startHour       Int?          
  endHour         Int?          
  multiplier      Float         @default(1)
  isActive        Boolean       @default(true)
  priority        Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  pricingConfig   PricingConfig @relation(fields: [pricingConfigId], references: [id], onDelete: Cascade)

  @@map("pricing_rules")
}

model Promotion {
  id              String        @id @default(uuid())
  pricingConfigId String
  name            String
  description     String?
  discountType    DiscountType  @default(PERCENTAGE)
  discountValue   Float         
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean       @default(true)
  usageLimit      Int?          
  usageCount      Int           @default(0)
  conditions      Json?         
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  pricingConfig   PricingConfig @relation(fields: [pricingConfigId], references: [id], onDelete: Cascade)
  plans           PromotionPlan[]

  @@map("promotions")
}

model PromotionPlan {
  id           String @id @default(uuid())
  promotionId  String @db.VarChar(100)
  planId       String @db.VarChar(100)

  // Relations
  promotion    Promotion   @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  plan         PricingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([promotionId, planId])
  @@map("promotion_plans")
}

model Review {
  id               String       @id @default(uuid())
  userId           String?      
  firstName        String
  lastName         String
  socialStatus     String
  photo            String?      
  rating           Int          
  comment          String       @db.Text
  status           ReviewStatus @default(PENDING)
  reviewedBy       String?      
  reviewedAt       DateTime?    
  moderatorComment String?      @db.Text
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  user             User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([rating])
  @@map("reviews")
}

// Enums
enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
  EMPLOYEE
}

enum BikeStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  UNAVAILABLE
}

enum RideStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  RIDE_PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}